# Simple Docker test pipeline for Buildkite
# Paste this into your pipeline settings to test Docker + GPU isolation + artifacts

steps:
  - label: ":whale: Docker GPU Test"
    agents:
      queue: "test"  # Change to your queue name

    plugins:
      - docker#v5.11.0:
          image: "nvidia/cuda:12.4.0-runtime-ubuntu22.04"
          always-pull: true
          gpus: "all"
          propagate-environment: true
          environment:
            - NVIDIA_VISIBLE_DEVICES
            - CUDA_VISIBLE_DEVICES
            - KERNELBOT_PAYLOAD
            - KERNELBOT_RUN_ID
          # Resource constraints from environment hook
          cpus: "${KERNELBOT_CPUS:-8}"
          memory: "${KERNELBOT_MEMORY:-64g}"

    command: |
      echo "=== Environment ==="
      echo "NVIDIA_VISIBLE_DEVICES=$$NVIDIA_VISIBLE_DEVICES"
      echo "CUDA_VISIBLE_DEVICES=$$CUDA_VISIBLE_DEVICES"
      echo "KERNELBOT_RUN_ID=$$KERNELBOT_RUN_ID"
      echo ""
      echo "=== GPU Info ==="
      nvidia-smi
      echo ""
      echo "=== CPU Info ==="
      nproc
      echo ""
      echo "=== Memory Info ==="
      free -h
      echo ""
      echo "=== Creating result.json ==="
      cat > result.json << JSONEOF
      {
        "success": true,
        "error": "",
        "runs": {},
        "system": {
          "gpu_name": "$$NVIDIA_VISIBLE_DEVICES",
          "cuda_version": "12.4",
          "python_version": "N/A"
        }
      }
      JSONEOF
      cat result.json
      echo ""
      echo "=== Done ==="

    artifact_paths:
      - "result.json"

    timeout_in_minutes: 5
